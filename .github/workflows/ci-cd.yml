name: UnoStat CI/CD

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # 1. Quality Check: Lint & Test
  quality:
    name: Code Quality & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache: true

      - name: Install GolangCI-Lint v2.8.0
        run: go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@v2.8.0

      - name: Run Tests
        run: go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...

  # 2. Build & Release (Only runs on Tag Push)
  release:
    name: Build & Release
    needs: quality
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # Windows
          - goos: windows
            goarch: amd64
            ext: .exe
          # Linux
          - goos: linux
            goarch: amd64
            ext: ""
          - goos: linux
            goarch: arm64
            ext: ""
          # macOS
          - goos: darwin
            goarch: amd64
            ext: ""
          - goos: darwin
            goarch: arm64
            ext: ""

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache: true

      - name: Set Build Variables
        id: vars
        shell: bash
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
          echo "COMMIT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Install and Run go-winres (Windows Only)
        if: matrix.goos == 'windows'
        run: |
          go install github.com/tc-hib/go-winres@latest
          cd cmd
          go-winres make --product-version ${{ steps.vars.outputs.VERSION }} --file-version ${{ steps.vars.outputs.VERSION }} --arch ${{ matrix.goarch }}

      - name: Build Binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
          LDFLAGS: >-
            -s -w
            -X 'github.com/phuonguno98/unostat/pkg/version.Version=${{ steps.vars.outputs.VERSION }}'
            -X 'github.com/phuonguno98/unostat/pkg/version.Commit=${{ steps.vars.outputs.COMMIT_HASH }}'
            -X 'github.com/phuonguno98/unostat/pkg/version.Date=${{ steps.vars.outputs.BUILD_DATE }}'
        run: |
          mkdir -p dist

          # Build Single Binary (unostat)
          go build -ldflags "$LDFLAGS" -o dist/unostat${{ matrix.ext }} ./cmd

      - name: Install Zip (for Windows packaging)
        if: matrix.goos == 'windows'
        run: sudo apt-get update && sudo apt-get install -y zip

      - name: Package Assets
        shell: bash
        run: |
          ASSET_NAME="unostat-${{ steps.vars.outputs.VERSION }}-${{ matrix.goos }}-${{ matrix.goarch }}"
          PKG_DIR="dist/$ASSET_NAME"

          mkdir -p $PKG_DIR

          # Move binary
          if [ "${{ matrix.goos }}" = "windows" ]; then
            mv -v dist/unostat.exe $PKG_DIR/
          else
            mv -v dist/unostat $PKG_DIR/
          fi

          # Copy documentation and license
          cp -v README.md LICENSE CHANGELOG.md $PKG_DIR/
          if [ -d "docs" ]; then cp -r docs $PKG_DIR/; fi

          # Debug: List package content
          ls -R $PKG_DIR

          # Archive
          cd dist
          if [ "${{ matrix.goos }}" = "windows" ]; then
            zip -r "$ASSET_NAME.zip" "$ASSET_NAME"
            echo "ASSET_PATH=dist/$ASSET_NAME.zip" >> $GITHUB_ENV
          else
            tar -czvf "$ASSET_NAME.tar.gz" "$ASSET_NAME"
            echo "ASSET_PATH=dist/$ASSET_NAME.tar.gz" >> $GITHUB_ENV
          fi

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.ASSET_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
